<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <title>Dörtgen Hareket Simülasyonu</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }

        svg {
            border: 1px solid black;
        }

        table {
            border: 1px solid black;
            text-align: center;
        }

        #hud td {
            font-weight: bold;
        }
    </style>
</head>

<body>
<h1>Burağın Matematik Yarışması</h1>
<div id="divMenu" style="display: block;">
    <button id="btnStart">Başlat</button>
</div>
<div id="divGame" style="display: none;">
    <svg id="level1">
        <g id="blocksContainer"></g>
        <rect id="player" width="0" height="0" fill="none" stroke="black"/>
    </svg>
    <div>
        <table id="hud">
            <tr>
                <td>
                    <p id="description"></p>
                </td>
            </tr>
            <tr>
                <td>
                    <p id="result"></p>
                </td>
            </tr>
        </table>
    </div>
</div>
<div id="divEndGame" style="display: none;">
    <p>Ne yazık ki yanlış cevap</p>
    <button id="btnBackToMenu">Başlat</button>
</div>

<script type="module">
    import init, {Game, Position} from './pkg/running_rectangle.js';

    async function run() {
        await init();
        const game = Game.new();

        document.getElementById('btnBackToMenu').addEventListener('click', () => {
            game.update_state("menu");
        });

        document.getElementById('btnStart').addEventListener('click', () => {
            console.log("Game started");
            game.init();
            game.update_state("playing");

            const level1 = document.getElementById('level1');
            const playerElement = document.getElementById('player');
            const hudElement = document.getElementById('hud');
            const descriptionElement = document.getElementById('description');

            hudElement.setAttribute('width', game.max_width);
            hudElement.setAttribute('height', '64px');
            descriptionElement.innerText = game.get_current_question_text();

            level1.setAttribute('width', game.max_width);
            level1.setAttribute('height', game.max_height);
            let player = game.get_player();

            playerElement.setAttribute('width', player.get_width().toString());
            playerElement.setAttribute('height', player.get_height().toString());

            function updatePosition() {
                playerElement.setAttribute('x', player.get_x().toString());
                playerElement.setAttribute('y', player.get_y().toString());
                game.update_player(Position.new(player.get_x(), player.get_y()));
            }

            updatePosition();

            window.addEventListener('keydown', event => {
                let amount = 20;
                switch (event.key) {
                    case 'ArrowLeft':
                        player.change_velocity(-amount, 0);
                        player.move_to();
                        break;
                    case 'ArrowRight':
                        player.change_velocity(amount, 0);
                        player.move_to();
                        break;
                    case 'ArrowUp':
                        player.change_velocity(0, -amount);
                        player.move_to();
                        break;
                    case 'ArrowDown':
                        player.change_velocity(0, amount);
                        player.move_to();
                        break;
                    case 'Escape':
                        game.update_state("menu");
                        break;
                }
                updatePosition();
            });

            function gameLoop() {
                game.update();
                game.draw();
                const resultElement = document.getElementById('result');

                if (game.collision_check()) {
                    resultElement.textContent = "Doğru";
                    game.update_state("endGame");
                } else {
                    resultElement.textContent = "";
                }
                requestAnimationFrame(gameLoop);
            }

            gameLoop();
        });
    }

    run();
</script>
</body>

</html>